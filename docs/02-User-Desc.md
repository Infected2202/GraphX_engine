**Пользовательское описание и правила (источник требований)**

## Сущности

* **Сотрудник**: `id`, ФИО, флаг стажёра (опц.), `mentor_id` (опц.), накопленный годовой перелимит (`ytd_overtime`).
* **Тип смены** (атом):

  * Идентификатор: `day_a`, `day_b`, `night_a`, `night_b`, `m8_a/b`, `e8_a/b`, `n4_a/b`, `n8_a/b`, `off`, `vac_wd8`, `vac_we0`.
  * Поля: код (`DA/DB/NA/NB/M8*/E8*/N4*/N8*/OFF/VAC*`), офис (`A/B/None`), начало/конец, **часы**, рабочая ли смена.
* **Шаблон смен**: фиксированный цикл **ДЕНЬ → НОЧЬ → ВЫХ → ВЫХ** (фазы `0..3`).
* **Офисы**: A и B — используются для ротации и покрытия дневных.
* **Отпуск**: список дат; применяем как «перекраску»: будни → `VAC8`, выходные → `VAC0`.

## Базовый цикл и ротация офисов

* Каждый сотрудник следует циклу фаз `0..3`:

  * `0 = DAY`, `1 = NIGHT`, `2 = OFF`, `3 = OFF`.
* «Семя» фазы (`seed4`) получается детерминированно из `id`.
* **Ротация A/B**: при **каждом рабочем выходе** (`DAY` или `NIGHT`) счётчик `work_turn` инкрементируется, и офис чередуется:

  * `turn` чётный → офис A, `turn` нечётный → офис B.
  * Это правило непрерывно через границы месяцев (учитываем историю от «эпохи» до 1-го числа месяца).
* Пример последовательности по офисам при идеальном цикле:
  `DA → NB → DB → NA → DA → NB → …` (чередование A/B на каждом рабочем шаге).

## Перенос ночной на границе месяца

* Если фаза **ночь** попадает на **последний день** месяца:

  * На последний день ставим **короткую ночь** `N4A/N4B` (21:00–00:00).
  * На 1-е число следующего месяца ставим **остаток ночи** `N8A/N8B` (00:00–09:00).
  * Вместе это **одна логическая смена**; `N8*` не увеличивает рабочий счётчик `work_turn` на 1-е.

## Отпуск (не влияет на паттерн)

* Не вмешивается в построение цикла.
* После генерации **перекрашиваем** только часы учёта:

  * Будний день → `VAC8` (8ч).
  * Выходной → `VAC0` (0ч).
* Ротация A/B, переносы `N4/N8`, паттерн фаз **не меняются**.

## Нормы/перелимит часов

* Месячная норма берётся из конфига.
* Допустимый перелимит в месяц и за год — параметры (по умолчанию 10/120).
* Если по сотруднику перерасход — **сокращаем только дневные 12ч** до 8ч:

  1. в выходные — `E8*`,
  2. затем в будни — `M8*`.
* Ночные (`NA/NB`, `N4/N8`) **не сокращаем**.

## Пары и «перемешивание» (следующий слой)

* **Пара**: два сотрудника, чьи коды смен совпадают много дней подряд (overlap по дню/ночи).
* Цель: **уменьшать** долю совпадений (особенно дневных) между одними и теми же людьми.
* Базовая идея: точечные **сдвиги** начала месяца (окно), не трогая `N8*` и инварианты, чтобы снизить pair-score.
* В том же слое — контроль **«соло»** (когда в дне только один дневной):

  * вести счётчик «соло-дней/месяцев»;
  * приоритезировать устранение «долгих соло» в будущих месяцах.

> **Примечание:** этот слой существует как отдельный модуль (PR-3), но **реализация не завершена**. См. документ «PR-3».

## Минимум покрытия и «помощники» (последующий слой)

* Требование «в дневную всегда ≥2 человека (A и B)» — **не** навязано базовому генератору.
* При недокомплекте — механизм вывода «помощника» (и чередование помощников), но это **после** стабилизации сдвигов/пар.

## Стажёры (последующий слой)

* Стажёр прикрепляется к наставнику и **копирует** его смены и офис; может не считаться в покрытие.
* Не влияет на паттерн наставника.

## Инварианты, которые всегда сохраняем

1. Фаза каждого дня для каждого сотрудника соответствует циклу `DAY → NIGHT → OFF → OFF`.
2. Ротация офисов A/B на **каждом** рабочем выходе, непрерывная межмесячно.
3. `N4` — только в **последний** день, `N8` — только **1-го** числа.
4. Отпуск — **перекраска**, не вмешивается в фазы/ротацию/переносы.
5. Сокращение часов — только `DAY 12ч → 8ч` (с приоритетом выходных).

## Важные уточнения (для будущей разработки)

* **Сдвиги делаем в начале месяца** (окно фиксированной длины), `N8*` не трогаем; `N4*` — производное и может пересчитаться.
* Сдвиг отклоняем, если **не улучшает** метрики (pair-score/solo-score/покрытие) или нарушает инварианты.
* При малом составе (4–5 человек) «соло» неизбежно — цель не допускать **устойчивого** соло у одних и тех же сотрудников месяцами подряд.
* Любые «софт-правила» должны иметь **фичефлаги** и пороги в конфиге (возможность включать/отключать по сценарию).
