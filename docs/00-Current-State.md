**Снимок состояния проекта (v2 + незавершённый PR-3)**

## Кратко

Проект генерирует помесячный график смен по базовому паттерну **DAY → NIGHT → OFF → OFF**, с корректной ротацией офисов A/B и переносом ночных на границах месяцев (N4/N8).
Выход: Excel-сетка и CSV-сетка (сотрудники × дни), а также вспомогательные CSV-метрики. Есть сценарный раннер для быстрой проверки разных составов и отпусков.

## Что реализовано (стабильная база)

* **Детерминированный генератор (база)**

  * Паттерн «день → ночь → вых → вых» (фазы 0..3).
  * **Ротация офисов** A/B через счётчик рабочих выходов `work_turn` (не прерывается между месяцами).
  * **Перенос ночи** на границе месяца:

    * Последний день: `N4A/N4B` (21:00–00:00).
    * 1-е число следующего месяца: `N8A/N8B` (00:00–09:00).
    * Это **одна логическая смена**; `N8*` не увеличивает `work_turn` на 1-е.
  * **Ограничение часов**: при превышении месячной нормы + буфер заменяются **дневные 12ч** на **8ч**:

    1. сначала выходные (`E8*`), 2) затем будни (`M8*`). Ночные и переносы не трогаем.
  * **Отпуска** применяются **после** генерации как «перекраска» (будни → `VAC8`, выходные → `VAC0`), не влияя на паттерн и ротацию.
* **Отчёты**

  * `.xlsx` с листом «График» (сетка с цветовой индикацией), «Аналитика» (длинный формат), «Коды» (легенда).
  * `_grid.csv` — та же сетка (удобно для дифф/скриптов).
  * Вспомогательные CSV: по сотрудникам (часы), по дням (покрытие), пары (`pairs.csv`).
  * Всё сохраняется в `reports/…`.
* **Оркестрация**

  * Генерация нескольких месяцев последовательно (например, **август → сентябрь 2025**), переносы `N8*` между ними, извлечение «хвоста» последних 4 дней для согласования старта следующего месяца.
* **Сценарии**

  * Набор типовых запусков (4–8 сотрудников, разные отпуска на стыке месяцев, недокомплект с «соло»).
  * Каждый сценарий пишет артефакты в `reports/scenarios/<имя-сценария>/…`.

## Что НЕ реализовано в базе (умышленно отложено)

* Минимум 2 человека в дневную смену (A и B) «во что бы то ни стало».
* «Помощники» при недокомплекте и их чередование.
* Стажёры (следование наставнику) — выключено.
* CP-SAT/оптимизатор — нет.
* Производственный календарь/эталон и строгие лимиты 10/120 как валидирующее правило (пока — параметры/метрики).

## Незавершённый **PR-3: Pair-Breaking (safe-mode)**

**Цель**: уменьшать «жёсткие пары» и снижать «соло» точечными сдвигами **в начале месяца** (окно), не нарушая паттерн, переносы `N4/N8` и ротацию A/B.

**Сделано в PR-3:**

* Добавлены модули: `pairing` (подсчёт пар/overlap), `balancer` (жадные сдвиги), `shifts_ops` (сдвиг сегмента), `coverage` (подсчёт покрытия/соло), `postprocess` (отпуск-перекраска), `scenarios` (набор сценариев).
* Добавлены логи: bootstrap-хвост, carry-in/out, «smoke» по первым дням (DA/DB/NA/NB).

**Почему эффект пока не виден:**

* `shifts_ops.shift_phase` **не меняет фактический `shift_key`** (обновлялись лишь часы/метки), из-за чего сетка внешне не меняется, пары сохраняются.
* Условия приёма сдвига недостаточно строгие: не контролируется ухудшение покрытия (число дат с `DA+DB≥2`), рост суммарных «соло» и т.п.
* `hours_delta` считается не как **дельта**.

**Ожидаем после доделок PR-3:**

* При включённом флаге `pair_breaking.enabled=True` — снижение суммарного pair-score и/или solo-score за счёт небольших сдвигов **только в начале месяца**, без порчи `N4/N8` и ротации.

**Что именно осталось для PR-3 (сверху вниз):**

1. В `shift_phase` при ротации **переназначать `shift_key`** (по целевому коду и офису) и считать **Δчасы**.
2. Ужесточить «accept»:

   * не уменьшать число дат в окне с `DA+DB≥2`;
   * не увеличивать **суммарные** «соло-дни» по людям;
   * не портить `carry_in/out` и базовые инварианты.
3. Приоритизация кандидатов по «истории соло-месяцев/дней».
4. После отпуск-перекраски — синхронизировать границы (`N4/N8` не должны «висеть»).
5. Расширить лог: до/после pair-score, solo-score, список принятых операций.

## Ключевые инварианты, которые нельзя ломать

* Паттерн фаз для каждого сотрудника: **DAY → NIGHT → OFF → OFF** (фазы 0..3).
* Ротация A/B при каждом **рабочем** выходе (дни+ночи) непрерывна межмесячно (через `work_turn`).
* `N4` — только **в последний день** месяца; `N8` — только **1-го**; вместе — одна ночь.
* Отпуск — это **перекраска** (VAC8/VAC0), он **не меняет** паттерн и `work_turn`.
* При сокращении часов трогаем только **дневные** (12→8), ночные/переносы — нет.