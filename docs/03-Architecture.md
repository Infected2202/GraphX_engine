**Слои, ответственность и контракты между ними**

## Картина целиком

Пайплайн строгий и детерминированный:

```
CONFIG
  └─→ generator (БАЗА)
        ├─ считает фазы от эпохи (1 янв)
        ├─ ротация A/B через work_turn
        ├─ переносы N4/N8 (последний/первый)
        ├─ месячные лимиты часов (12→8 только для DAY)
        └─→ SCHEDULE, CARRY_OUT
               └─→ postprocess (перекраска отпусков)
                      └─→ schedule'
                             ├─→ (опц.) pairing/balancer/shifts_ops  ← PR-3 (незавершён)
                             │         └─→ schedule''
                             ├─→ report (xlsx + csv)
                             └─→ validator (инварианты, smoke)
```

> Источник правды по текущей реализации — документ из canvas **“Simple Schedule Generator (Python CLI) — v2 (Excel + Оркестратор)”**.

---

## Слои и ответственность

### 1) **generator** (базовый слой)

* **Вход**: `CONFIG.months[i]`, `employees`, `shift_types`, `carry_in` (обычно `N8*` на 1-е число).
* **Выход**: `schedule: Dict[date, List[Assignment]]` на месяц; `carry_out: List[Assignment]` (список `N8*` для 1-го числа следующего месяца).
* **Что делает:**

  * Фазы по «эпохе» (1 января) → цикл `DAY → NIGHT → OFF → OFF`.
  * Ротация офисов A/B: при **каждом рабочем выходе** (`DAY`/`NIGHT`) инкрементирует `work_turn` и чередует офис.
  * Граница месяца: если ночь выпала на последний день → ставит `N4*` + формирует `N8*` на 1-е следующего месяца.
  * Лимиты часов в месяце (и годовой периметр): если перерасход → заменяет **дневные 12ч** на **8ч** (приоритет — выходные `E8*`, затем будни `M8*`). **Ночные и переносы не трогаем**.
* **Чего НЕ делает:**

  * Не «подгоняет» график под отпуска (это пост-этап).
  * Не разрывает пары, не выводит «помощников», не оптимизирует покрытие.
  * Не трогает `N8*`, пришедшие carry-in’ом.

### 2) **postprocess**

* **Назначение**: «перекраска» отпусков поверх уже построенного паттерна.
* **Поведение**: будни отпуска → `VAC8`, выходные отпуска → `VAC0`.
* **Не меняет**: фазы, ротацию A/B, переносы `N4/N8`.

### 3) **pairing / balancer / shifts_ops** *(надстройка, PR-3)*

* **Назначение**: уменьшать «жёсткие пары», снижать «соло» минимальными сдвигами **в начале месяца** (окно).
* **Правила**:

  * `N8*` не трогать; `N4*` — производное (пересчитывается).
  * Не ломать базовый паттерн и ротацию A/B.
  * Приём сдвига только если метрики улучшаются и инварианты сохраняются.
* **Статус**: заготовка есть, реализация неполная (см. `06-PR3-PairBreaking.md`).

### 4) **report**

* Excel «сетка» (сотрудники × дни), лист «Аналитика» (длинный формат), «Коды» (легенда).
* CSV `_grid.csv`, метрики по сотрудникам/дням, пары.
* Визуальная кодировка: DAY/ NIGHT/ SHORT/ N4/N8/ OFF/ VAC*.

### 5) **validator**

* Проверяет базовые инварианты (цикл фаз, границы `N4/N8`, отсутствие дублей назначений).
* Smoke-сводка: статистика по первым дням (DA/DB/NA/NB), наличие «соло»-дней.
* Не навязывает «минимум 2 дневных» — это в последующих PR.

### 6) **orchestrator** (`app` / `scenarios`)

* Последовательный прогон месяцев, перенос `carry_out → carry_in`.
* Поддержка «синтетического хвоста» на первом месяце (для отладки).
* Сбор артефактов и логов по сценариям (4–8 сотрудников, отпуска на стыке, недокомплект).

---

## Контракты между слоями

* **Schedule contract**: на каждую дату для каждого сотрудника — **ровно один** `Assignment`.
* **Carry-in/out**: `N8*` на **1-е** числа — источник/приёмник только через интерфейс переноса; внутри месяца `N8*` не создаётся.
* **Postprocess**: может только заменить ключ на `VAC8/VAC0` (учёт часов), но не меняет структуру и не разрушает переносы.
* **Balancer**: работает **после** postprocess, в окне начала месяца; запрещено снижать покрытие и увеличивать «соло»-сумму.

---

## Инварианты (жёсткий контракт системы)

1. Цикл на сотрудника: `DAY → NIGHT → OFF → OFF` (фазы 0..3).
2. Чередование офисов A/B на **каждом** рабочем выходе (сквозное по месяцам).
3. `N4*` — только **последний день** месяца; `N8*` — только **1-е** числа; вместе — одна ночь.
4. Перекраска отпусков — не меняет фазы/ротацию/переносы.
5. Сокращение часов — только `DAY 12ч → 8ч`, и только в генераторе.

---

## Точки расширения (куда добавлять новое)

* Мин. покрытие и «помощники» → **новый слой** после генератора, до/после balancer (определить порядок).
* Стажёры → пост-правило отрисовки смен поверх наставника (не влияет на базовый цикл).
* Производственный календарь → валидатор + конфиг-нормы; изменения часов остаются в генераторе.
* CP-SAT → отдельный «улучшатель» поверх базового расписания (в опытном режиме).
