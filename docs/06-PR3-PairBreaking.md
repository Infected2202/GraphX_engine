**Разрыв пар (safe-mode) — описание незавершённого PR**

## Цель

Снизить «жёсткость» пар (повторяющихся соседств по сменам) и уменьшить «соло»-нагрузку **минимальными сдвигами в начале месяца**, не нарушая:

* базовый цикл фаз и ротацию A/B,
* переносы `N4/N8`,
* лимиты часов.

## Постановка (user-story)

> Как координатор, хочу, чтобы в новом месяце сотрудники **меньше совпадали одними и теми же парами** и при этом **не было одиноких дневных** там, где можно этого избежать безопасным сдвигом начала.

## Scope / Non-scope

* **В scope:** локальные изменения **первых `window_days`** дней месяца; отключение/включение фичи флагом.
* **Вне scope:** перебор всего месяца, силовые перестройки, принудительная перекраска ночных, изменение отпусков.

## Вход/Выход

* **Вход:** `schedule` после генерации и postprocess’а (VAC* уже нанесён); параметры `pair_breaking`.
* **Выход:** изменённый `schedule` (локально), лог операций, метрики «до/после».

## Метрики/цели

* **pair-score**: суммарное число совпадений кодов смен между одними и теми же сотрудниками в окне (особенно DAY).
* **solo-score**: суммарное число «соло»-дней (дневной A xor B) в окне.
* **coverage-ok days**: число дат, где `DA+DB ≥ 2`.
* **Δhours** по сотруднику (должен остаться в допустимом бюджете; в PR-4 появится компенсация M8/E8).

## Операции (представление)

* **`shift_phase(e, window, dir)`**: сдвиг фаз сотрудника `e` в окне `dir ∈ {−1, +1}` с пересборкой ключей смен:

  * сохраняем структуру «рабочие/выходные» в окне, но **переупорядочиваем** их по шаблону (единичный сдвиг цикла),
  * **обязательно меняем** `shift_key` на новый (DA/DB/NA/NB/N4 и т.п.) по правилам ротации A/B и границ месяца,
  * считаем **Δчасы** как «после − до» внутри окна.
* **Запреты:** не переписывать `N8*` 1-го числа; не допускать `N8*` в середине месяца; не ставить две записи сотруднику в один день.

## Алгоритм (жадный safe-mode)

1. **Кандидаты**: отсортировать сотрудников по убыванию pair-score и/или истории «соло-месяцев».
2. Для каждого кандидата пробовать `dir ∈ {−1, +1}`:

   * построить «виртуальный» новый срез окна, **переназначая `shift_key`** с учётом ротации A/B и границ месяца;
   * **валидация**: инварианты базового слоя не нарушены; `N8*` не тронут; `coverage-ok days` не уменьшилось; `solo-score` не вырос ни по сотруднику, ни в окне; `Δчасы` укладывается в бюджет (или =0 на этапе PR-3);
   * **принятие**: если `pair-score` снизился **и** условия выше соблюдены → применить; записать в лог.
3. Ограничения: `max_ops` операций на месяц; `hours_budget` (пока 0 или малый).

## Параметры конфига

```yaml
pair_breaking:
  enabled: false
  overlap_threshold: 0.6     # что считаем «жёсткой парой»
  window_days: 6             # сколько первых дней рассматриваем
  max_ops: 4                 # максимум успешных сдвигов на месяц
  hours_budget: 0            # допустимая сумма Δчасов (PR-3: 0; PR-4: >0 с M8/E8)
```

## Журналирование (что писать в лог)

* Кандидаты и порядок рассмотрения.
* По каждой попытке: сотрудник, `dir`, `Δpair`, `Δsolo` (общая и по окну), `Δcoverage_ok`, `Δhours`, verdict (accepted/rejected) и причина.
* Итоговые метрики окна.

## Тестовые сценарии (ожидания)

* **7 и 5 сотрудников**: хотя бы 1–2 успешных сдвига в окне без ухудшения покрытия; снижение pair-score.
* **Отпуск в начале месяца**: попытки в окно с отпуском отклоняются либо обходятся без ухудшений; `N8*` остаётся нетронутым.
* **Переносы N4/N8**: стабильны; не появляется «N4» вне последнего дня.

## Статус доработок

* ✅ `shift_phase` перезаписывает `shift_key` и часы прямо в расписании окна, устраняя фиктивные ротации.
* ✅ Критерии приёма контролируют покрытие, суммарные «соло» (в том числе по окну) и бюджет часов.
