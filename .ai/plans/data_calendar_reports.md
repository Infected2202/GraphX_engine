# Data · Calendar · Reports — ExecPlan

Этот ExecPlan — **живой документ**. Поддерживайте актуальными разделы `Progress`, `Surprises & Discoveries`, `Decision Log`, `Outcomes & Retrospective`. Стиль и структура соответствуют ExecPlans из Cookbook.

## Purpose / Big Picture

Сформировать в веб-приложении устойчивый контур **Данные → Календарь → Отчёты**:

* **Данные календаря**: праздники, рабочие выходные, нормы часов, отпуска — с импортом (JSON/XLSX/CSV), ручной правкой и хранением в SQLite.
* **Интеграция с генерацией**: генератор всегда использует **предыдущий календарный месяц** как контекст; календарные типы и отпуска влияют на результат и метрики.
* **Отчёты и экспорт**: вычислять метрики (часы/нормы/переработки/сокращения), выводить их в веб и экспортировать в XLSX/CSV, сохранив визуальное соответствие текущему XLSX из репозитория.

**Наблюдаемый результат (E2E):**
Запуск `flask run` → страница **Calendar** позволяет отметить праздники и загрузить отпуска; страница **Editor** генерирует месяц (контекст — предыдущий), страница **Reports** показывает корректные часы/нормы/переработки, **Export XLSX** совпадает по стилям с текущими отчётами.

## Progress

* [ ] (2025-10-28) Схема БД для календаря/отпусков/отчётов применена (миграция 0001+).
* [ ] (2025-10-28) Импорт JSON календаря (совместим с текущей структурой сценариев).
* [ ] (2025-10-28) Импорт отпусков (JSON/CSV), ручная правка в UI.
* [ ] (2025-10-28) Учёт норм часов и рабочих выходных в генерации (через сервис календаря).
* [ ] (2025-10-28) Блок отчётов (часы по сотруднику/офису, нормы, переработка, сокращения).
* [ ] (2025-10-28) Экспорт отчётов в CSV/XLSX (визуально согласовано с текущими стилями XLSX).
* [ ] (2025-10-28) Документация по загрузке/верификации данных и сценариям.

## Surprises & Discoveries

* Observation: …
  Evidence: …

## Decision Log

* Decision: **Календарь/нормы/отпуска** — в БД; **легенда/цвета** — в `shift_types.json`; **настройки** — в `settings.json`.
  Rationale: Разделяем данные и визуальные настройки, упрощаем версионирование и правку.
  Date/Author: 2025-10-28 GraphX

* Decision: Импортers принимают **текущую JSON-структуру сценариев из репозитория** без преобразований; XLSX/CSV — через явное сопоставление колонок.
  Rationale: Репозиторий — источник правды по структурам; минимизируем расхождения.

* Decision: **Визуальная согласованность** отчётов: стили и палитры XLSX из веб-экспорта совпадают с текущими отчётами в репозитории (OFF/выходные/сокращённые смены).
  Rationale: Единый визуальный язык между веб и существующим экспортом.

## Outcomes & Retrospective

После реализации: генерация учитывает праздники/переносы/нормы/отпуска; отчёты воспроизводимы и совпадают по числам с эталонами из сценариев; веб-экспорт XLSX визуально совпадает с текущим.

## Context and Orientation

* **Репозиторий** `Infected2202/GraphX_engine`: сценарии содержат примеры целевого использования и структуры данных; отчёты в XLSX задают палитру/стили ячеек — наш эталон.
* **Базовый план**: генерация — библиотекой, без записи на диск; контекст — **предыдущий месяц**; Flask + SQLite; JSON-конфиги для легенды/настроек.

## Plan of Work

1. **Схема БД и DAO**

   * Таблицы:

     * `calendar_days(date TEXT PK, day_type TEXT, norm_minutes INTEGER)` — `day_type ∈ {workday, weekend, holiday, shifted}`.
     * `vacations(id PK, emp_id, start_date, end_date, kind TEXT)` — отпуска/больничные.
     * `reports(id PK, month_id, name, payload_json, created_at)` — кэш вычисленных отчётов.
     * (Уже есть) `months`, `employees`, `schedule_cells`.
   * DAO-методы: выборка календаря на год/месяц; апсерты дней; CRUD отпусков; загрузка/сохранение отчётов.

2. **Контракты данных**

   * **Calendar JSON (импорт/экспорт)**

     ```
     {
       "year": 2025,
       "holidays": ["2025-01-01", "2025-01-07", ...],
       "shifted_workdays": ["2025-01-11", ...],
       "norm_minutes": {"2025-01": 13520, "...": ...}
     }
     ```
   * **Vacations JSON/CSV**

     ```
     [{"emp_key":"E01","start":"2025-01-15","end":"2025-01-28","kind":"paid"}]
     ```

     CSV: `emp_key,start,end,kind`

3. **Импортеры и мердж-правила**

   * **JSON календаря**: полная замена записей за указанный год (`upsert` по `date` и `ym`).
   * **Отпуска**: добавление/обновление по `(emp_id, start, end)`; пересечения объединяем (нормализуем интервалы).
   * **XLSX/CSV**: маппинг колонок → те же структуры, явная валидация; ошибки — с отчётом строк.

4. **Сервис календаря и генерация**

   * Сервис предоставляет:

     * `get_month_context(prev_ym)` для генератора;
     * `is_holiday(date)`, `is_shifted_workday(date)`; `norm_minutes(ym)`;
     * `vacations_by_emp(ym)`.
   * Генератор использует эти данные при **base assignment** и **downstream adjustments** (подробности — в `generation_pipeline.md`).

5. **Отчёты и метрики**

   * Метрики:

     * **Часы по сотруднику/офису**; **сравнение с нормой**; **переработка/недоработка**;
     * **Сокращения (8ч)**: сколько применено/пропущено и почему;
     * **Дни отпуска** (по видам).
   * Отображение: страница **Reports** (таблица + сводки);
   * Экспорт: `CSV` (плоские таблицы), `XLSX` (лист(ы) с палитрой/стилями в соответствии с текущими отчётами).

6. **Веб-эндпоинты**

   * `GET /api/calendar?year=YYYY` — данные года; `POST` — импорт JSON.
   * `POST /api/calendar/import-xlsx` / `/import-csv` — загрузка файла, отчёт валидации.
   * `GET/POST /api/vacations` — список/импорт; `DELETE /api/vacations/:id`.
   * `GET /api/reports?month=YYYY-MM` — список;
     `GET /api/reports/<name>?month=YYYY-MM&format=json|csv|xlsx`.

7. **Визуальная согласованность**

   * **Правила цвета/стиля** для: выходных/праздников, OFF, сокращённых смен — берём из текущего XLSX в репозитории и переносим в веб-CSS/XLSX-рендер.

## Concrete Steps

1. **Миграции**

   * Добавить `graphx_web/migrations/0002_calendar.sql` с таблицами `calendar_days`, `vacations`, `reports`.
   * Обновить `dao/db.py` для применения миграции.

2. **DAO**

   * `calendar_dao.py`: `upsert_days(year_payload)`, `load_month(ym)`, `norm_minutes(ym)`.
   * `vacations_dao.py`: CRUD + нормализация пересечений.
   * `reports_dao.py`: `save(name, ym, payload)`, `load(name, ym)`.

3. **Сервис**

   * `calendar_service.py`: инварианты (тип дня ↔ норма), API для генератора.
   * Подключить сервис в `generator_adapter` (использование предыдущего месяца — из базового плана).

4. **Импорт/экспорт**

   * Эндпоинты загрузки файлов; валидация; отчёт об ошибках (строка/поле/причина).
   * Экспорт отчётов: CSV (стандарт), XLSX (`BytesIO`) со стилями как в текущем проекте.

5. **UI**

   * **Calendar**: мини-календарь месяца, клики по дням (holiday/shifted/workday), поля нормы на `YYYY-MM`, список отпусков с CRUD.
   * **Reports**: таблицы «часы/нормы/переработка», «сокращения», «отпуска»; кнопки `Export CSV/XLSX`.

## Validation and Acceptance

* **Импорт календаря**: загрузка JSON на год → `GET /api/calendar?year=...` возвращает ровно эти дни/нормы.
* **Отпуска**: импорт 3 пересекающихся интервалов для сотрудника → в списке один объединённый интервал.
* **Генерация**: изменяем праздник/рабочую субботу в месяце `M-1` → повторная генерация `M` меняет соответствующие ячейки по правилам пайплайна.
* **Отчёты**: сумма часов по сотруднику совпадает с «часы = норма ± переработка».
* **Экспорт**: CSV читабелен в Excel; XLSX визуально совпадает с текущим отчётом (точечная проверка цветов OFF/выходных/сокращённых).

## Idempotence and Recovery

* Импорт JSON/XLSX/CSV — идемпотентен (повтор приводит к тем же данным).
* Неуспешный импорт не меняет БД; возвращается отчёт ошибок.
* Кэш отчётов в `reports` можно пересоздавать детерминированно (очистка по `ym,name`).

## Artifacts and Notes

* Примеры файлов импорта: `examples/calendar_2025.json`, `examples/vacations.csv`.
* Скриншоты сверки цветов между веб и XLSX.
* Протокол валидации импорта (N строк, K ошибок, примеры).

## Interfaces and Dependencies

* **Flask** блюпринт `calendar` и `reports`; `openpyxl/xlsxwriter` для XLSX; `csv`/`pandas` — опционально.
* **Сервисный контракт** для генератора: `calendar_service.get_month_context(prev_ym)`, `vacations_by_emp(ym)`, `norm_minutes(ym)`.
* **Форматы API**: как описано в эндпоинтах выше.
* **ExecPlan методология**: разделы, критерии приёмки, требования к самодостаточности — см. Cookbook.

