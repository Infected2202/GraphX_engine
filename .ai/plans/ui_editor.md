# UI & Editor — ExecPlan

Этот ExecPlan — **живой документ**. Разделы `Progress`, `Surprises & Discoveries`, `Decision Log` и `Outcomes & Retrospective` необходимо поддерживать в актуальном состоянии по мере реализации.

Если в корне репозитория присутствует `PLANS.md`, этот документ следует поддерживать **в соответствии с ним** и не дублировать уже определённые цели MVP. Этот план покрывает фронт/UX и редактор расписаний в веб-интерфейсе (Flask + SQLite), включая таблицу редактирования, легенду/цвета, удобства календаря и взаимодействие с бекенд-эндпоинтами редактора. Основано на текущем состоянии кода в `GraphX_engine` (ядро генерации, сценарии, xlsx-стили).

## Purpose / Big Picture

Пользователь открывает `/editor?month=YYYY-MM`, видит **таблицу смен** «сотрудники × дни месяца» со **стилями, соответствующими xlsx-отчёту** из генератора; кликает по ячейке, выбирает значение из выпадающего списка (или выполняет пакетную операцию), накапливает правки в **черновике** и жмёт **Commit** для применения. Доступны: **Generate** (контекст — предыдущий календарный месяц), **Export XLSX** (параметрически совместим со стилями Excel в текущем проекте), быстрые операции (мультивыделение, «сдвиг фазы»), и вспомогательные панели: **Сотрудники**, **Календарь**, **Типы смен** (легенда). В репозитории присутствуют коммиты про слой сокращения смен и правки палитры Excel/стилей выходных, что задаёт требования к согласованности визуализации в вебе с тем, что генерируется в XLSX.

## Progress

* [x] (2024-05-21 UTC) Каркас страниц и сайдбар; `/editor` отрисовывает сетку read-only (Jinja).
* [ ] (2025-10-28) Легенда/цвета из `shift_types.json` применяются как CSS-классы.
* [ ] (2025-10-28) Редактирование ячеек: селектор значений, мультивыделение, «сдвиг фазы».
* [ ] (2025-10-28) Черновик правок: `POST /api/schedule/draft` → `POST /api/schedule/commit`.
* [ ] (2025-10-28) Кнопки **Generate** и **Export XLSX** подключены к API.
* [ ] (2025-10-28) UX-валидации и доступность (клавиатура/aria).
* [ ] (2025-10-28) Документация по запуску/проверке сценариев UI.

## Surprises & Discoveries

* Observation: …
  Evidence: …

## Decision Log

* Decision: Используем «без сборки» фронт: Jinja + HTMX (inline-AJAX) + небольшой JS (Alpine/ваниль).
  Rationale: Однопользовательское локальное приложение, быстрый TTM, соответствие базовому плану MVP.
  Date/Author: 2025-10-28 GraphX

* Decision: Веб-легенда (цвета/подписи) должна **визуально совпадать** со стилями из XLSX, включая особые цвета для выходных/сокращённых смен.
  Rationale: В репозитории есть коммиты, изменяющие палитру и стили для выходных/short-shifts; веб обязан отображать те же семантики.
  Date/Author: 2025-10-28 GraphX 

## Outcomes & Retrospective

По завершении: сопоставление скриншотов веб-таблицы и XLSX (на выборке дней/сотрудников), проверка пакетных операций, сценарий «Generate → правки → Commit → Export».

## Context and Orientation

**Репозиторий:** `Infected2202/GraphX_engine` (Python, генератор расписаний и формирование Excel). В истории — выделение слоя «сокращения смен», сценарии/загрузчик JSON и правки палитры/стилей Excel для выходных/коротких смен. Эти изменения определяют требования к UI:
— Веб-таблица обязана использовать те же ключи смен (DA/NB/OFF/… + офис NB/NA/вариант) и те же визуальные семантики, что и Excel-отчёт.
— Контекст генерации — предыдущий месяц (см. базовый план).
— Сценарии в репозитории дают примеры целевого использования и структуры данных (JSON).

**Определения:**

* **Ячейка**: `{emp_id, day, value, office, meta}` где `value` — ключ смены (DA/NB/… или OFF), `office` — NB/NA/вариант; `meta.class` даёт CSS-классы для окраски.
* **Черновик правок**: временное хранилище пачек операций (set/shift_phase/bulk-set), применяемое транзакцией.
* **Легенда**: `shift_types.json` — сопоставление ключей смен стилям (фон/текст/граница), включая особые стили для выходных/сокращённых смен (8ч).

## Plan of Work

1. **Шаблоны и каркас**

   * Добавить `templates/_layout.html` с сайдбаром: Editor, Employees, Calendar, Shift Types, Reports, Settings (состояние активной вкладки).
   * Страница `templates/editor/index.html`: заголовок, селектор месяца (YYYY-MM), кнопки **Generate**, **Commit**, **Export XLSX**, индикатор «Draft: N edits».

2. **Отрисовка таблицы (read-only)**

   * Сервер: `GET /api/schedule?month=YYYY-MM` возвращает структуру `employees[]`, `days_in_month`, `cells[]`.
   * Клиент: Jinja рендерит HTML-таблицу. Каждая ячейка получает классы из `meta.class`, построенные на базе легенды: напр., `cell-DA NB`, `cell-OFF weekend-text`.
   * Синхронизация цветов с xlsx: палитра/правила для выходных и «short shift» (8ч) отражены в `shift_types.json` и CSS (например, `.cell-OFF.weekend-text { color: … }`). В репозитории были коммиты, корректирующие палитру/стили выходных — учесть те же оттенки в вебе.

3. **Интерактивное редактирование**

   * Клик по ячейке → выпадающий список значений (ключи смен + варианты офиса).
   * **Мультивыделение**: `Ctrl`/`Shift` (строки, диапазоны дней) + панель «Bulk actions»: Set Value, Set Office, Shift Phase (±N).
   * Быстрые клавиши:

     * `Enter`/`Esc`: применить/снять редактирование;
     * `←/→/↑/↓`: навигация;
     * `Ctrl+Z / Ctrl+Y`: локальный undo/redo в рамках несохранённого черновика.
   * Валидации на клиенте: подсветка конфликтов (например, смена в праздник с несоответствующим типом), отображение подсказок по доступным значениям.

4. **Черновик и коммит**

   * `POST /api/schedule/draft` принимает `{ edits: [{emp_id, day, op, new_value?, new_office?, delta?}] }`, возвращает счётчик черновика.
   * Индикатор «Draft: N edits» обновляется без перезагрузки (HTMX).
   * `POST /api/schedule/commit` — применяет транзакционно, очищает черновик, возвращает итоговую статистику.

5. **Генерация и экспорт**

   * `POST /api/schedule/generate?month=YYYY-MM` — пересборка сетки (контекст — предыдущий месяц; слой сокращения смен применяется в пайплайне генератора; UI получает готовую матрицу).
   * `GET /api/export/xlsx?month=YYYY-MM` — скачивание Excel; стили и цвета совпадают с веб-легендой.

6. **Легенда/цвета**

   * `GET /api/shift-types` → JSON легенды; `POST` — сохранение.
   * UI-редактор: предпросмотр ячейки (фон/текст/граница), подсказки по ключам и офисам.
   * Важные семантики из истории репозитория (OFF/выходной цвет текста, «short shift» палитра) закрепить в дефолтном `shift_types.json`, чтобы соответствовать текущему xlsx.

7. **Календарные удобства (минимум для редактора)**

   * В мини-панели месяца показывать иконки праздников/рабочих выходных (из БД); ховер по дню — подсказка «праздник/норма часов».
   * Неблокирующая подсветка несовместимых сочетаний (например, короткая смена вне выходного).

8. **Доступность и устойчивость**

   * Табличная навигация с клавиатуры, aria-метки для ячеек и контрола редактирования.
   * Защита от «двойного клика» на Commit/Generate (disable во время запроса).
   * Блок восстановления: если запрос на `draft` не прошёл — локально сохраняем очередь до повтора.

## Concrete Steps

1. **Маршруты и шаблоны**

   * Добавить блюпринт `graphx_web/blueprints/editor/routes.py`:

     * `GET /editor` (Jinja),
     * `GET /api/schedule`,
     * `POST /api/schedule/draft`, `POST /api/schedule/commit`,
     * `POST /api/schedule/generate`,
     * `GET /api/export/xlsx`.
   * Шаблоны: `templates/_layout.html`, `templates/editor/index.html`.

2. **CSS/JS**

   * `static/css/app.css`: базовая сетка, классы легенды, состояние ячеек (focus/selected/error).
   * `static/js/editor.js`: выбор/мультивыделение, локальный undo/redo, сбор батчей правок.
   * Подключить HTMX (как статику) для обновлений счётчиков/фрагментов страницы.

3. **Связь с легендой**

   * Загрузка `shift_types.json` на страницу (встраивание через Jinja как JSON) → генерация классов для каждой ячейки.
   * Обеспечить соответствие ключей и цветов тем, что видны в Excel сейчас (с учётом коммитов про OFF/выходные/short shift).

4. **Серверная часть (минимум для UI)**

   * Методы DAO для чтения/записи черновика и месячной сетки.
   * Сериализация в JSON формата: `{employees[], days_in_month, cells[]}`.

5. **Проверка сценариев**

   * Запуск `flask run` → `GET /editor?month=YYYY-MM`.
   * Нажать **Generate** → таблица заполняется; изменить 5–10 ячеек, **Commit** → `Draft: 0 edits`.
   * **Export XLSX** → открыть и визуально сверить цвета/подписи с веб.

## Validation and Acceptance

* **Навигация и редактирование:** стрелки двигают фокус; Enter открывает селектор; Esc отменяет; мультивыделение работает; ошибки валидации подсвечиваются.
* **Черновик:** после серии правок индикатор показывает `N > 0`; после **Commit** — `0`.
* **Генерация:** **Generate** обновляет таблицу; время выполнения разумное для типичной выборки.
* **Экспорт:** скачанный Excel открывается; стили для OFF/выходных/сокращённых смен соответствуют веб-цветам (точечная проверка на нескольких днях и сотрудниках).
* **Идемпотентность:** повторный **Commit** без новых правок ничего не меняет; повторная отрисовка месяца детерминирована для одинаковых входов.

## Idempotence and Recovery

* Все POST-операции идемпотентны на уровне сервера (повтор без изменений безопасен).
* Черновик хранится отдельно; при ошибке коммита состояние основной сетки не меняется.
* Отрисовка таблицы не изменяет БД.
* Экспорт не изменяет состояние.

## Artifacts and Notes

* Скриншоты сравнения веб-таблицы и Excel.
* Файлы: `graphx-YYYY-MM.xlsx` после экспорта; JSON дамп легенды, если правилась.
* Важно: ориентироваться на текущие примеры сценариев и стили Excel из репозитория (включая изменения палитры/стилей в недавних коммитах) при настройке веб-легенды.

## Interfaces and Dependencies

* **Зависимости UI**: Flask (Jinja2), HTMX (static), небольшой JS (Alpine/vanilla).
* **Данные**: `GET /api/schedule` (матрица), `POST /api/schedule/draft|commit|generate`, `GET /api/export/xlsx`, `GET/POST /api/shift-types`.
* **Легенда**: `shift_types.json` — источник классов/цветов.
* **Совместимость с генератором**: генерация использует предыдущий календарный месяц; слой сокращения смен применяется в пайплайне генератора (см. общий PLANS.md и историю репозитория).

