## 1) Быстрый старт (локально)

**Требования:** Python **3.11+** (используется `|` в аннотациях типов), Git.

```bash
# 1) создать изолированное окружение
python -m venv .venv
# Unix/macOS:
source .venv/bin/activate

# 2) базовые dev-инструменты
pip install --upgrade pip
pip install ruff black mypy pytest

# 3) запустить быструю проверку качества кода
ruff check ...
black --check ...
mypy ...
```

> Если для работы появятся внешние зависимости , установи и добавь их в `requirements.txt`.

## 2) Как запускать логику проекта (ориентиры)

Проект собран вокруг слоёв генерации и инфраструктуры:

* Точка запуска для сценариев/отчётов: `engine/cli/app.py`
* Конвейер и сценарии: `engine/infrastructure/scenarios.py`
* Базовая конфигурация: `engine/infrastructure/config.py`
* Производственный календарь и нормы: `engine/infrastructure/production_calendar.py`
  Дефолтные данные: `engine/infrastructure/data/production_calendar_2025.json`
* Доменные сущности: `engine/domain/*.py` (`Employee`, `Assignment`, `ShiftType`, …)
* Генерация/постпроцессинг: `engine/services/*.py`
  (например, `generator.py`, `shortener.py`, `pairing.py`, `balancer.py`, `postprocess.py`, `validator.py`)
* Отчёты: `engine/presentation/report.py`

### Мини-план для агента (безопасный «скелет» скрипта)

Если нужно быстро проверить гипотезу / внедрить правку в генератор:

1. Загрузить календарь: `ProductionCalendar.load_default()`.
2. Импортировать `CONFIG` из `engine.infrastructure.config`.
3. Инициализировать `Generator(CONFIG, calendar=calendar)`.
4. Вызвать соответствующие методы генератора (см. код) и передать результат в модуль отчётов.
5. Вывести CSV/Excel в каталог `output/` (создать, если нет).

> Если нужного метода нет/неочевиден — **опроси код** (поиском по репо) и предложи минимальный патч вместо догадок.

## 3) Карта проекта (что где лежит)

* `engine/domain/shift.py` — объявление смен и кодов:

  * **День**: `DA`, `DB`, укороченные `M8A`, `M8B`, `E8A`, `E8B`
  * **Ночь**: `NA`, `NB`, смены на границы месяца с переносом `N4A`, `N4B`, следующий месяц `N8A`, `N8B`
  * **Выходной/отпуска**: `OFF`, `VAC8`, `VAC0`
* `engine/infrastructure/config.py` — ключевые секции:

  * `shift_types` — словарь ключ → параметры (код, офис A/B, часы, ярлык, рабочий/нерабочий).
  * `employees` — сотрудники (id, имя, стажёр/ментор, накопленные часы…).
  * `months` — целевые месяцы и их частные настройки (отпуска и т. п.).
  * `coverage` — требования к покрытию дневных слотов (например, `require_day_a`, `require_day_b`).
  * `recolor` — «перекраска» (вариант L), по умолчанию выключена.
  * `logging` — формат логов и ограничение на объём.
  * `pair_breaking` — параметры «расшивки» сильных пар (см. поля: `enabled`, `overlap_threshold`, `hours_budget`, `window_days`, `max_ops`, `anti_align`, `post_desync_all`, `fixed_pairs`, `intern_ids`, `norm_by_employee`).
* `engine/infrastructure/production_calendar.py` — месячные нормы и правила выходных/праздников:

  * `allows_shortening(date)` возвращает, можно ли **сокращать** смены в дату (выходной/праздник, без принудительных «рабочих суббот»).
* `engine/services/generator.py` — составной генератор; внутри подключается `ShiftShortener` c `ShorteningConfig`.
* `engine/services/shortener.py` — слой **сокращения** дневных смен (в выходные/праздники превращение в `M8*`/`E8*`), учитывая офис и условия (см. ниже).

## 4) Инварианты и правила генерации (Только для чтения)

* **Сокращение смен (M8/E8)** — это **послеслой**: выполняется **после** уже существующих слоёв генерации.
  Сокращаются **только дневные** смены в **выходные/праздники**, **и только когда в дне задействованы 2 человека** (закрытие утреннего и вечернего слотов A/B).
  Основание — `ProductionCalendar.allows_shortening` + конфигурация `ShorteningConfig`.
* **Пары и анти-синхронизация**: при «расшивке» пар не допускать «залипания» сотрудников в одинаковых фазах цикла; используйте параметры `pair_breaking` и учитывайте `anti_align`.
* **Коды смен → офис**: по суффиксу `A/B`. Для `OFF/VAC*` офиса нет.
* **Фазность**: сид-фаза на 1 число месяца вытекает из «хвоста» прошлого месяца (см. логику в `generator.py`: DAY→NIGHT, NIGHT→OFF, OFF→…).
* **Код генератора зморожен, его нельзя изменять!**


## 5) Потоки ввода/вывода

* **Вход**: конфигурация (`engine/infrastructure/config.py`), календарь (`engine/infrastructure/data/*.json`), так же сценарии для быстрой проверки.
* **Выход**: артефакты отчётов класть в `./output/` (CSV/XLSX/лог-сводки).
  *Не* коммитьте генерируемые файлы; при необходимости добавьте/проверьте `.gitignore`.

## 6) Разрешения и безопасность

**Можно без запроса:**

* читать/просматривать код и данные;
* править **локально** код в `engine/*` с малыми диффами;
* запускать **точечные** проверки качества (`ruff`, `black --check`, `mypy`) и **единичные** тесты (если появятся).

**Запрещено:**

* массовые рефакторинги;
* изменение структуры и методов генерации.

## 7) Команды (ориентиры для агента)

> Файло-ориентированные проверки предпочтительны — быстрее обратная связь.

```bash
# Линт конкретного файла
ruff check path/to/file.py

# Формат конкретного файла
black path/to/file.py

# Mypy по пакету/модулю
mypy engine/services/generator.py

# Pytest точечно (когда появятся тесты)
pytest -q -k "shortener or generator"

# Запуск утилиты/CLI (если есть main/entrypoint)
python -m engine.cli.app          # либо: python engine/cli/app.py
```

> Если прямого CLI входа нет — добавь минимальный `__main__`/`main()` в `engine/cli/app.py` **отдельным патчем** (малый дифф, без сторонних пакетов).

## 8) PR-чек-лист

* Заголовок: `краткое описание изменений`
* Локально пройдены проверки: `ruff`, `black --check`, `mypy`, точечные `pytest` (если есть).
* Удали «отладочные» логи/комментарии перед коммитом.
* Выходные файлы — только в `output/`, **не** в трекере Git.

## 9) Когда застряли — сперва план

* Сформулируй короткий план правки (1–3 шага) или открой **draft PR** с заметками.
* Не вноси «большую догадочную правку» единым диффом.

## 10) Стиль кода

* PEP8, типизация `typing`/`dataclasses`.
* Именование переменных/функций — описательно, без аббревиатур, если они не доменные (`DA/DB/NA/NB` — допустимы).
* Предпочтение **малых, целевых** функций вместо многоходовок.
* Логи: коротко и по делу; «шум» выноси под флаг конфигурации.


---

### Памятка агенту

* Начинай с **малых диффов** и **файло-ориентированных** команд (lint/type/test по отдельным файлам).
* Вся генерация/отчёты — в `output/`.
* Дополняй AGENTS.md, кроме разделов "только для чтения", поддерживай актуальность.
* Акутализируй README.md в соответствии с изменениями.
* "Движок" генератора настроен и функционирует корректно, не меняй правила генерации. Если это необходимо - уточни у пользователя.
